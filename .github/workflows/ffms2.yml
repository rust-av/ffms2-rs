name: ffms2

on:
  push:
  pull_request:
    types: [opened, synchronize]

jobs:
  clippy-format:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install FFmpeg
      run: |
        sudo apt update
        sudo apt install libavcodec-dev libavformat-dev libavdevice-dev zlib1g-dev

    - name: Install ffms2 (2.40)
      run: |
        git clone --depth 1 --branch 2.40 https://github.com/ffms/ffms2.git
        cd ffms2
        ./autogen.sh --prefix=$HOME/ffms2-dir --enable-static --disable-shared
        sudo make install

    - name: Install Rust stable
      uses: dtolnay/rust-toolchain@stable
      with:
        components: clippy, rustfmt

    - name: Run cargo fmt
      run:
        cargo fmt --all -- --check --verbose

    - name: Run cargo clippy
      uses: giraffate/clippy-action@v1
      with:
        github_token: ${{ secrets.github_token }}
        clippy_flags: --all-targets -- -d warnings
        reporter: github-pr-check

  tests:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install FFmpeg
      run: |
        sudo apt update
        sudo apt install libavcodec-dev libavformat-dev libavdevice-dev zlib1g-dev

    - name: Install ffms2 (2.40)
      run: |
        git clone --depth 1 --branch 2.40 https://github.com/ffms/ffms2.git
        cd ffms2
        ./autogen.sh --prefix=$HOME/ffms2-dir --enable-static --disable-shared
        sudo make install

    - name: Install Rust Stable
      uses: dtolnay/rust-toolchain@stable

    - name: Set pkg-config variable
      run: |
        echo "PKG_CONFIG_PATH=$HOME/ffms2-dir/lib/pkgconfig" >> "$GITHUB_ENV"

    - name: Run tests
      run: |
        cargo test --all-features
